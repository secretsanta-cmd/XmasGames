<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Boss Final ü¶ç</title>
<style>
body {
  margin: 0;
  background: black;
  color: white;
  text-align: center;
  font-family: sans-serif;
}
canvas {
  background: #111;
  display: block;
  margin: auto;
}
#controls {
  position: fixed;
  right: 20px;
  top: 120px;
  width: 220px;
  padding: 15px;
  background: rgba(0,0,0,0.7);
  border: 2px solid white;
  border-radius: 10px;
  text-align: left;
  font-size: 14px;
  color: white;
}
#controls h3 { margin-top: 0; text-align: center; }
</style>
</head>
<body>

<h1>ü¶ç Ascension finale</h1>
<p>Monte, saute et √©vite les tonneaux !</p>

<canvas id="game" width="600" height="400"></canvas>

<div id="controls">
<h3>üéÆ Contr√¥les</h3>
<ul>
<li>‚¨ÖÔ∏è / ‚û°Ô∏è : Se d√©placer</li>
<li>‚¨ÜÔ∏è : Monter une √©chelle/sauter</li>
</ul>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const WIDTH = canvas.width;
const HEIGHT = canvas.height;

// === CAMERA ===
let cameraY = 0;

// === SPRITES ===
const playerImg = new Image(); playerImg.src = "canard.png";
const bossImg = new Image(); bossImg.src = "chasseur.png";
const ladderImg = new Image(); ladderImg.src = "echelle.png";

// === TIMER DE D√âBUT ===
let gameStarted = false;
let countdown = 3;
const countdownInterval = setInterval(() => {
  countdown--;
  if (countdown <= 0) {
    gameStarted = true;
    clearInterval(countdownInterval);
  }
}, 1000);

// === JOUEUR ===
const player = {
  x: 50, y: 300, w: 24, h: 27,
  vx: 0, vy: 0, speed: 3, jump: -5,
  onGround: false, onLadder: false,
  jumpTime: 0, isJumping: false,
  canGrabLadder: false
};

// === PLATEFORMES ===
const platforms = [];
for(let i=0;i<12;i++){
  platforms.push({x:(i%2===0)?0:150, y:360 - i*80, w:450, h:15});
}
player.y = platforms[0].y - player.h;
player.onGround = true;

// === BOSS ===
const boss = {x:260, y:platforms[platforms.length-1].y-50, size:40};
let bossActive = false;

// === √âCHELLES ===
const ladders = [];
for(let i=0;i<11;i++){
  ladders.push({x:(i%2===0)?120:300, y:platforms[i].y-80, h:80});
}
// Supprimer 3 √©chelles √©quilibr√©es (sauf premi√®re et derni√®re)
const totalLadders = ladders.length;
[ Math.floor(totalLadders/4), Math.floor(totalLadders/2), Math.floor(3*totalLadders/4) ]
.sort((a,b)=>b-a).forEach(i => ladders.splice(i,1));

// === TONNEAUX ===
let barrels = [];
let barrelTimer = 0;

// === INPUT ===
const keys = {};
window.addEventListener("keydown", e => keys[e.key]=true);
window.addEventListener("keyup", e=>{
  keys[e.key]=false;
  if(e.key==="ArrowUp" && player.vy<0) player.isJumping=false;
});

// === PHYSIQUE ===
const gravity = 0.5;
const jumpHoldGravity = 0.12;
const maxJumpHoldTime = 25;

function isOnScreen(y,height=0){
  return y+height+cameraY >=0 && y+cameraY <= HEIGHT;
}

// Spawn tonneau
function spawnBarrel(){
  if(!bossActive){
    barrels.push({x:Math.random()*(WIDTH-40)+20, y:cameraY-20, r:8, vx:Math.random()<0.5?-2:2, vy:0});
  } else {
    barrels.push({x:boss.x+boss.size/2, y:boss.y+boss.size, r:10, vx:Math.random()<0.5?-2:2, vy:0});
  }
}

// === UPDATE ===
function update(){
  player.vx=0;
  if(gameStarted){
    if(keys["ArrowLeft"]) player.vx=-player.speed;
    if(keys["ArrowRight"]) player.vx=player.speed;
  }

  // Gravit√© et saut prolong√©
  if(!player.onGround && !player.onLadder){
    if(player.isJumping && keys["ArrowUp"] && player.jumpTime<maxJumpHoldTime){
      player.vy+=jumpHoldGravity;
      player.jumpTime++;
    } else player.vy+=gravity;
  }

  player.x+=player.vx;
  player.y+=player.vy;
  player.x=Math.max(0, Math.min(WIDTH-player.w, player.x));

  // === COLLISIONS PLATEFORMES ===
  player.onGround=false;
  platforms.forEach(p=>{
    if(player.vy>=0 && player.x+player.w>p.x && player.x<p.x+p.w && player.y+player.h<=p.y && player.y+player.h+player.vy>=p.y){
      player.y=p.y-player.h; player.vy=0; player.onGround=true;
      player.isJumping=false; player.jumpTime=0;
    }
    if(player.vy<0 && player.x+player.w>p.x && player.x<p.x+p.w && player.y>=p.y+p.h && player.y+player.vy<=p.y+p.h){
      player.y=p.y+p.h; player.vy=0;
    }
  });

  // === √âCHELLES ===
  player.onLadder=false;
  ladders.forEach(l=>{
    if(player.x+player.w>l.x && player.x<l.x+30 && player.y+player.h>l.y && player.y<l.y+l.h){
      player.onLadder=true;
    }
  });

  // Peut attraper √©chelle uniquement si au sol ou sur plateforme
  player.canGrabLadder = player.onLadder && player.onGround;
  if(keys["ArrowUp"] && player.canGrabLadder) player.vy=-player.speed;
  if(keys["ArrowDown"] && player.canGrabLadder) player.vy=player.speed;

  // Saut initial
  if(keys["ArrowUp"] && player.onGround && !player.isJumping && !player.canGrabLadder){
    player.vy=player.jump;
    player.isJumping=true; player.jumpTime=0;
  }

  // CAMERA
  cameraY = Math.min(cameraY, player.y - HEIGHT/2);

  // Boss activation
  if(!bossActive && isOnScreen(boss.y,boss.size)) bossActive=true;

  // Spawn tonneaux
  barrelTimer++;
  if(barrelTimer>70){ spawnBarrel(); barrelTimer=0; }

  // Tonneaux
  barrels.forEach(b=>{
    b.vy+=gravity; b.x+=b.vx; b.y+=b.vy;
    if(b.x-b.r<0 || b.x+b.r>WIDTH) b.vx*=-1;
    platforms.forEach(p=>{
      if(b.x>p.x && b.x<p.x+p.w && b.y+b.r>=p.y && b.y+b.r<=p.y+10){ b.y=p.y-b.r; b.vy=0; }
    });
  });

  // Collision tonneau
  for(const b of barrels){
    if(b.x>player.x && b.x<player.x+player.w && b.y>player.y && b.y<player.y+player.h){
      alert("üí• Touch√© !"); location.reload();
    }
  }

  // Victoire
  if(player.x+player.w>boss.x && player.x<boss.x+boss.size && player.y<boss.y+boss.size){
    alert("üèÜ Victoire finale !"); location.reload();
  }
}

// === DRAW ===
function draw(){
  ctx.clearRect(0,0,WIDTH,HEIGHT);
  ctx.save(); ctx.translate(0,-cameraY);

  // Boss
  if(bossImg.complete) ctx.drawImage(bossImg,boss.x,boss.y,boss.size,boss.size);
  else {ctx.fillStyle="brown"; ctx.fillRect(boss.x,boss.y,boss.size,boss.size);}

  // Plateformes
  ctx.fillStyle="#888"; platforms.forEach(p=>ctx.fillRect(p.x,p.y,p.w,p.h));

  // √âchelles
  ladders.forEach(l=>{
    if(ladderImg.complete) ctx.drawImage(ladderImg,l.x,l.y,30,l.h);
    else {ctx.fillStyle="#4dd0ff"; ctx.fillRect(l.x,l.y,30,l.h);}
  });

  // Joueur
  if(playerImg.complete) ctx.drawImage(playerImg,player.x,player.y,player.w,player.h);
  else {ctx.fillStyle="yellow"; ctx.fillRect(player.x,player.y,player.w,player.h);}

  // Tonneaux
  ctx.fillStyle="orange";
  barrels.forEach(b=>{ctx.beginPath();ctx.arc(b.x,b.y,b.r,0,Math.PI*2);ctx.fill();});

  // D√©compte
  if(!gameStarted){
    ctx.fillStyle="white"; ctx.font="48px sans-serif";
    ctx.fillText(countdown, WIDTH/2-12, HEIGHT/2);
  }

  ctx.restore();
}

function loop(){ update(); draw(); requestAnimationFrame(loop); }
loop();
</script>
</body>
</html>
